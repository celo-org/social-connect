---
name: Build ODIS loadtest image

on:
  push:
    paths:
      - 'dockerfiles/phone-number-privacy/Dockerfile-loadtest'
      - 'packages/phone-number-privacy/monitor/**'
    branches:
      - main
  pull_request:
    paths:
      - 'dockerfiles/phone-number-privacy/Dockerfile-loadtest'
      - 'packages/phone-number-privacy/monitor/**'
  workflow_dispatch:

jobs:
  odis-loadtest-build-dev:
    uses: celo-org/reusable-workflows/.github/workflows/container-cicd.yaml@7b956940a337e987289a6788c5a562a3e1e5c2ab
    name: Build us-west1-docker.pkg.dev/devopsre/dev-images/odis-loadtest
    if: |
      github.ref != 'refs/heads/main'
    with:
      workload-id-provider: projects/1094498259535/locations/global/workloadIdentityPools/gh-social-connect/providers/github-by-repos
      service-account: 'social-connect-dev@devopsre.iam.gserviceaccount.com'
      artifact-registry: us-west1-docker.pkg.dev/devopsre/dev-images/odis-loadtest
      tag: ${{ github.sha }}
      platforms: 'linux/amd64'
      context: .
      file: dockerfiles/phone-number-privacy/Dockerfile-loadtest
      trivy: true

  odis-loadtest-build:
    uses: celo-org/reusable-workflows/.github/workflows/container-cicd.yaml@7b956940a337e987289a6788c5a562a3e1e5c2ab
    name: Build us-west1-docker.pkg.dev/devopsre/social-connect/odis-loadtest
    if: |
      github.ref == 'refs/heads/main'
    with:
      workload-id-provider: projects/1094498259535/locations/global/workloadIdentityPools/gh-social-connect-main/providers/github-by-repos
      service-account: 'social-connect@devopsre.iam.gserviceaccount.com'
      artifact-registry: us-west1-docker.pkg.dev/devopsre/social-connect/odis-loadtest
      tag: ${{ github.sha }}
      platforms: 'linux/amd64'
      context: .
      file: dockerfiles/phone-number-privacy/Dockerfile-loadtest
      trivy: true
